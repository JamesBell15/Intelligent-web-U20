<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-aFq/bzH65dt+w6FI2ooMVUpc+21e0SRygnTpmBvdBgSdnuTN7QbdgL+OapgHtvPp" crossorigin="anonymous">
        <link rel='stylesheet' href='/stylesheets/chat.css'>
        <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
        <script>
            const requestIDB = indexedDB.open('db', 4)

            requestIDB.onupgradeneeded = (event) => {
                const db = requestIDB.result
                db.createObjectStore('userInfo', {autoIncrement: false})
                console.log('IDB: Object store created.')
            }

            requestIDB.onerror = (event) => {
                console.error('IDB: '+requestIDB.error)
            }

            requestIDB.onsuccess = (event) => {
                const checkLoginStatus =  () => {
                    const db = requestIDB.result
                    const storeRequest = db.transaction('userInfo', 'readonly').objectStore('userInfo').get('user')
                    storeRequest.onsuccess = (event) => {
                        const user = event.target.result
                        if (user) {
                            document.getElementById('loginModalBtn').classList.add('hidden')
                            document.getElementById('logoutBtn').classList.remove('hidden')
                            document.getElementById('profileBtn').classList.remove('hidden')
                            document.getElementById('profileBtn').innerText = user.username
                        }
                    }
                }
                checkLoginStatus()
            }

        </script>
    </head>
    <body>
        <% include ../public/partials/navbar.ejs %>
        <div id="chatRoomMain">
            <form id="chatRoomForm" onsubmit="return false">
                <input
                        id="chatRoomIn"
                        type="text"
                        placeholder="Create room"
                        required
                        autocomplete="off"
                />
                <input id="addChatRoomBtn" type="button" value="Add"/>
            </form>
            <section id="chatRoomCatalogue">
                <div id="noChatRoomsMsg"><%= typeof message != 'undefined' ? message : '' %></div>
                <% if (typeof rooms != 'undefined'){%>
                    <%for (let room of rooms) {%>
                        <div chat-room-id="<%= room %>"><%= room %></div>
                    <%}%>
                <%}%>
            </section>
        </div>
        <div id="chatMain" class="hidden">
            <div id="chatTitle"></div>
            <section id="chatHistory">
            </section>
            <form class="chatFormContainer" onsubmit="return false;">
                <input
                        id="msgIn"
                        type="text"
                        placeholder="Enter Message"
                        required
                        autocomplete="off"
                />
                <input id="sendMsgBtn" type="button" value="Send"/>
                <input id="exitChatBtn" type="button" value="Exit"/>
            </form>
        </div>
        <script src="javascripts/chat.js"></script>
        <script src="javascripts/user.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/js/bootstrap.min.js" integrity="sha384-heAjqF+bCxXpCWLa6Zhcp4fu20XoNIA98ecBC1YkdXhszjoejr5y9Q77hIrv8R9i" crossorigin="anonymous"></script>
    </body>
</html>